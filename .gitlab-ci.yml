stages:
    - build
    - deploy

build:
    image: gradle:6.7.1-jdk11
    stage: build
    script: ./gradlew clean build
    before_script:
        - export GRADLE_USER_HOME=`pwd`/.gradle
    artifacts:
        paths:
            - ./build/libs/VetApp-0.0.1-SNAPSHOT.jar

deploy:
    image: docker:stable
    stage: deploy
    variables:
        CONTAINER_IMAGE: registry.gitlab.com/$CI_PROJECT_PATH
        DOCKER_HOST: tcp://docker:2375
        DOCKER_DRIVER: overlay2
    services:
        - docker:dind
    before_script:
        - docker login --username=$HEROKU_USER --password=$HEROKU_API_KEY registry.heroku.com
        - apk add --update curl && rm -rf /var/cache/apk/*
    script:
        - docker build --build-arg JAR_FILE="./build/libs/VetApp-0.0.1-SNAPSHOT.jar" --build-arg DB_URI=$HEROKU_DB_URI --build-arg DB_USER=$HEROKU_DB_USER --build-arg DB_PASSWORD=$HEROKU_DB_PASSWORD --tag registry.heroku.com/$HEROKU_APP_NAME/web .
        - docker push registry.heroku.com/$HEROKU_APP_NAME/web

        - IMAGE_ID=`docker inspect registry.heroku.com/$HEROKU_APP_NAME/web --format={{.Id}}`
        - curl \
            -n \
            -X PATCH https://api.heroku.com/apps/$HEROKU_APP_NAME/formation \
            -d '{"update":[{"type":"web", "docker_image":"'"$IMAGE_ID"'"}]}' \
            -H "Content-Type:application/json" \
            -H "Accept:application/vnd.heroku+json; version=3.docker-releases" \
            -H "Authorization:Bearer $HEROKU_API_KEY"
